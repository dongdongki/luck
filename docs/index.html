<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>존나실력 게임 | Luck Games</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="screen active">
            <div class="logo">🎮</div>
            <h1>존나실력 게임</h1>
            <p class="subtitle">다양한 실력 게임에 도전하세요!</p>
            <div class="input-group">
                <input type="text" id="nickname" placeholder="닉네임을 입력하세요" maxlength="20">
                <button id="start-btn" class="btn btn-primary">입장하기</button>
            </div>
            <p class="hint" id="error-msg" style="color: #ef4444; display: none;"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCGYumcqNoGU5qDY8oaRThCxm8am9QFT7U",
            authDomain: "luck-9cf68.firebaseapp.com",
            projectId: "luck-9cf68",
            storageBucket: "luck-9cf68.firebasestorage.app",
            messagingSenderId: "975535609399",
            appId: "1:975535609399:web:b94e1e4a07d75df82391b2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const nicknameInput = document.getElementById('nickname');
        const startBtn = document.getElementById('start-btn');
        const errorMsg = document.getElementById('error-msg');

        // 저장된 닉네임 불러오기
        const savedNickname = localStorage.getItem('luckGameNickname');
        if (savedNickname) {
            nicknameInput.value = savedNickname;
        }

        // 사용했던 닉네임 목록 불러오기
        function getUsedNicknames() {
            const stored = localStorage.getItem('luckGameUsedNicknames');
            return stored ? JSON.parse(stored) : [];
        }

        // 닉네임을 사용 목록에 추가
        function addUsedNickname(nickname) {
            const usedNicknames = getUsedNicknames();
            if (!usedNicknames.includes(nickname)) {
                usedNicknames.push(nickname);
                localStorage.setItem('luckGameUsedNicknames', JSON.stringify(usedNicknames));
            }
        }

        async function checkAndProceed() {
            const nickname = nicknameInput.value.trim();

            if (!nickname) {
                errorMsg.textContent = '닉네임을 입력해주세요!';
                errorMsg.style.display = 'block';
                nicknameInput.focus();
                return;
            }

            // 이전에 사용한 닉네임이면 중복 체크 건너뛰기
            const usedNicknames = getUsedNicknames();
            const isMyNickname = usedNicknames.includes(nickname);

            if (!isMyNickname) {
                try {
                    // luck_scores와 timer_scores 모두 체크
                    const luckDoc = await getDoc(doc(db, "luck_scores", nickname));
                    const timerDoc = await getDoc(doc(db, "timer_scores", nickname));

                    if (luckDoc.exists() || timerDoc.exists()) {
                        errorMsg.textContent = '이미 사용 중인 닉네임입니다.';
                        errorMsg.style.display = 'block';
                        nicknameInput.focus();
                        return;
                    }
                } catch (error) {
                    console.error('닉네임 체크 실패:', error);
                }
            }

            // 닉네임 저장 및 사용 목록에 추가
            localStorage.setItem('luckGameNickname', nickname);
            addUsedNickname(nickname);
            window.location.href = 'games.html';
        }

        startBtn.addEventListener('click', checkAndProceed);
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkAndProceed();
        });
        nicknameInput.addEventListener('input', () => {
            errorMsg.style.display = 'none';
        });
    </script>
</body>
</html>
